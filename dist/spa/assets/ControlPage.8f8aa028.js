import{z as m,f as M,n as ve,o as g,c as C,w as l,H as u,a as r,Q as P,J as fe,I as k,K as ge,N as Y,Z as p,L as F,M as b,a0 as D,X as G,bf as pe,az as be,b5 as _e}from"./index.0418bc8d.js";import{Q as B}from"./QSelect.e99ebc92.js";import{Q as q}from"./QTooltip.616e6e1b.js";import{Q as U,a as ye}from"./QTable.17f2e81d.js";import{Q as R}from"./QBadge.81599d26.js";import{Q as we}from"./QPage.c34053e1.js";import{C as Ce}from"./ClosePopup.ad21a613.js";import{u as ke}from"./use-quasar.d200e14e.js";import{api as S}from"./axios.0ee954dc.js";import{_ as he}from"./plugin-vue_export-helper.21dcd24c.js";import"./QChip.9d792c62.js";import"./QItem.b86f3ea8.js";import"./position-engine.40d3e3b8.js";import"./QList.329cacdc.js";const xe={name:"ControlPage",setup(){const v=ke(),t=m([]),Q=m([]),a=m(null),h=m(null),E=m(null),e=m({label:"Todos",value:null}),f=m(!1),_=m(""),y=m([]),V=m(!1),j=m(!1),L=m(!1),A=m({id:null,sede:null,carrera:null}),H=m([]),J=m([]),N=m([]),Z=[{label:"Todos",value:null},{label:"Pendientes",value:"null"},{label:"Subidas",value:"SUBIDA"},{label:"Aprobadas",value:"APROBADO"},{label:"Denegadas",value:"DENEGADO"}],W=[{name:"docente",label:"Docente",align:"left",sortable:!0},{name:"sede_carrera",label:"Sede - Carrera",align:"left"},{name:"tipo_contrato",label:"Tipo",field:"tipo_contrato",align:"center"},{name:"monto",label:"Monto",field:"monto",align:"right",format:o=>`Bs. ${o}`,sortable:!0},{name:"carga_horaria",label:"Carga",field:"carga_horaria",align:"center",sortable:!0},{name:"fecha_subida",label:"Fecha de Subida",align:"center",sortable:!0},{name:"estado_subida",label:"Estado",align:"center"},{name:"actions",label:"Acciones",align:"center"}],$=M(()=>{const o=[...new Set(t.value.map(n=>{var d,s;return(s=(d=n.sede_carrera)==null?void 0:d.sede)==null?void 0:s.nombre}).filter(Boolean))];return[{label:"Todas",value:null},...o.map(n=>({label:n,value:n}))]}),ee=M(()=>{var d;let o=t.value;(d=h.value)!=null&&d.value&&(o=o.filter(s=>{var i,c;return((c=(i=s.sede_carrera)==null?void 0:i.sede)==null?void 0:c.nombre)===h.value.value}));const n=[...new Set(o.map(s=>{var i,c;return(c=(i=s.sede_carrera)==null?void 0:i.carrera)==null?void 0:c.nombre}).filter(Boolean))];return[{label:"Todas",value:null},...n.map(s=>({label:s,value:s}))]}),ae=M(()=>{var n,d;let o=t.value;if((n=h.value)!=null&&n.value&&(o=o.filter(s=>{var i,c;return((c=(i=s.sede_carrera)==null?void 0:i.sede)==null?void 0:c.nombre)===h.value.value})),(d=E.value)!=null&&d.value&&(o=o.filter(s=>{var i,c;return((c=(i=s.sede_carrera)==null?void 0:i.carrera)==null?void 0:c.nombre)===E.value.value})),_.value){const s=_.value.toLowerCase();o=o.filter(i=>{var O,z,x,T;const c=`${((O=i.docente)==null?void 0:O.apellidos)||""} ${((z=i.docente)==null?void 0:z.nombre)||""}`.toLowerCase(),w=((T=(x=i.docente)==null?void 0:x.ci)==null?void 0:T.toLowerCase())||"";return c.includes(s)||w.includes(s)})}return o}),oe=()=>{E.value=null},te=o=>{if(!o)return"-";const n=new Date(o),d=String(n.getDate()).padStart(2,"0"),s=String(n.getMonth()+1).padStart(2,"0"),i=n.getFullYear(),c=String(n.getHours()).padStart(2,"0"),w=String(n.getMinutes()).padStart(2,"0");return`${d}/${s}/${i} ${c}:${w}`},le=async()=>{try{const o=localStorage.getItem("token"),n=await S.get("/cortes",{headers:{Authorization:`Bearer ${o}`}});Q.value=n.data,a.value=Q.value.find(d=>d.estado===1)||Q.value[0],a.value&&I()}catch{v.notify({type:"negative",message:"Error al cargar cortes"})}},I=async()=>{var o;if(!!a.value){f.value=!0;try{const n=localStorage.getItem("token"),d={corte_id:a.value.id,tipo_contrato:"FACTURACION"};((o=e.value)==null?void 0:o.value)!==null&&(d.estado_subida=e.value.value);const s=await S.get("/facturaciones",{params:d,headers:{Authorization:`Bearer ${n}`}});t.value=s.data}catch{v.notify({type:"negative",message:"Error al cargar facturaciones"})}finally{f.value=!1}}},re=o=>{const s=`${"https://api.sirred.xpertiaplus.com/api".replace(/\/api\/?$/,"")}/storage/${o.factura_path}`;window.open(s,"_blank")},ne=async o=>{var n,d;v.dialog({title:"Confirmar Aprobaci\xF3n",message:`\xBFAprobar la factura de ${(n=o.docente)==null?void 0:n.nombre} ${(d=o.docente)==null?void 0:d.apellidos}?`,cancel:!0,persistent:!0}).onOk(async()=>{var s,i;try{const c=localStorage.getItem("token");await S.post(`/facturaciones/${o.id}/approve`,{},{headers:{Authorization:`Bearer ${c}`}}),v.notify({type:"positive",message:"Factura aprobada correctamente"}),I()}catch(c){v.notify({type:"negative",message:((i=(s=c.response)==null?void 0:s.data)==null?void 0:i.message)||"Error al aprobar factura"})}})},se=async o=>{var n,d;v.dialog({title:"Confirmar Denegaci\xF3n",message:`\xBFDenegar la factura de ${(n=o.docente)==null?void 0:n.nombre} ${(d=o.docente)==null?void 0:d.apellidos}?`,cancel:!0,persistent:!0}).onOk(async()=>{try{const s=localStorage.getItem("token");await S.post(`/facturaciones/${o.id}/deny`,{},{headers:{Authorization:`Bearer ${s}`}}),v.notify({type:"positive",message:"Factura denegada"}),I()}catch{v.notify({type:"negative",message:"Error al denegar factura"})}})},de=async()=>{var o,n,d,s,i;try{const c=localStorage.getItem("token"),w={corte_id:a.value.id,tipo_contrato:"FACTURACION"};((o=e.value)==null?void 0:o.value)!==null&&((n=e.value)==null?void 0:n.value)!=="null"?w.estado_subida=e.value.value:((d=e.value)==null?void 0:d.value)==="null"&&(w.estado_subida="null"),(s=h.value)!=null&&s.value&&(w.sede_nombre=h.value.value),(i=E.value)!=null&&i.value&&(w.carrera_nombre=E.value.value);const O=await S.get("/facturaciones/export",{params:w,headers:{Authorization:`Bearer ${c}`},responseType:"blob"}),z=window.URL.createObjectURL(new Blob([O.data])),x=document.createElement("a");x.href=z;const T=O.headers["content-disposition"];let K="Facturas_Export.xlsx";if(T){const X=T.match(/filename="?(.+)"?/);X&&(K=X[1])}x.setAttribute("download",K),document.body.appendChild(x),x.click(),x.remove(),window.URL.revokeObjectURL(z),v.notify({type:"positive",message:"Excel exportado correctamente"})}catch{v.notify({type:"negative",message:"Error al exportar Excel"})}},ie=async()=>{try{const o=localStorage.getItem("token"),[n,d]=await Promise.all([S.get("/sedes",{headers:{Authorization:`Bearer ${o}`}}),S.get("/carreras",{headers:{Authorization:`Bearer ${o}`}})]);H.value=n.data,J.value=d.data}catch(o){console.error("Error loading metadata",o)}},ce=()=>{j.value=!0,A.value={id:null,sede:null,carrera:null},N.value=[],V.value=!0},ue=o=>{if(!o){N.value=[],A.value.carrera=null;return}N.value=J.value},me=async()=>{var o,n;if(!A.value.sede||!A.value.carrera){v.notify({type:"warning",message:"Seleccione Sede y Carrera"});return}L.value=!0;try{const d=localStorage.getItem("token"),s=y.value.map(i=>i.id);await S.post("/facturaciones/bulk-update",{ids:s,sede_id:A.value.sede.id,carrera_id:A.value.carrera.id},{headers:{Authorization:`Bearer ${d}`}}),v.notify({type:"positive",message:"Registros actualizados correctamente"}),y.value=[],V.value=!1,I()}catch(d){v.notify({type:"negative",message:((n=(o=d.response)==null?void 0:o.data)==null?void 0:n.message)||"Error al actualizar"})}finally{L.value=!1}};return ve(()=>{le(),ie()}),{facturaciones:t,cortes:Q,selectedCorte:a,selectedSede:h,selectedCarrera:E,estadoSubida:e,loading:f,searchQuery:_,sedeOptions:$,carreraOptions:ee,filteredFacturaciones:ae,estadoOptions:Z,columns:W,onSedeChange:oe,formatDate:te,loadFacturaciones:I,downloadFactura:re,approveFactura:ne,denyFactura:se,exportToExcel:de,editDialog:V,isBulkEdit:j,editForm:A,selected:y,allSedes:H,availableCarreras:N,openBulkEditDialog:ce,onEditSedeChange:ue,saveEdit:me,savingEdit:L}}},Se={class:"row q-col-gutter-md"},Ee={class:"col-12 col-sm-6 col-md-2"},Ae={class:"col-12 col-sm-6 col-md-2"},Fe={class:"col-12 col-sm-6 col-md-2"},Ve={class:"col-12 col-sm-6 col-md-2"},De={class:"col-12 col-sm-12 col-md-4"},Be={class:"row justify-between items-center q-mb-md"},Ue={class:"text-subtitle1 text-grey-8"},Qe={class:"row q-gutter-sm"},Ie={class:"text-weight-bold"},Oe={class:"text-caption text-grey-7"},ze={class:"text-caption text-grey-7"},Te={key:0},qe={key:1,class:"text-grey-6"},Re={class:"row q-gutter-xs no-wrap"},Ne={class:"text-h6"},Pe={key:0,class:"text-caption text-grey-7"},Le={class:"q-gutter-md"};function Me(v,t,Q,a,h,E){return g(),C(we,{padding:""},{default:l(()=>[t[19]||(t[19]=u("div",{class:"q-mb-md"},[u("div",{class:"text-h5 text-weight-medium"},"Control de Facturas"),u("div",{class:"text-caption text-grey-7"},"Gestione y apruebe las facturas subidas por los docentes")],-1)),r(Y,{class:"q-mb-md shadow-2",flat:"",bordered:""},{default:l(()=>[r(P,{class:"bg-grey-2"},{default:l(()=>[...t[9]||(t[9]=[u("div",{class:"text-subtitle1 text-grey-8"},"Filtros",-1)])]),_:1}),r(fe),r(P,null,{default:l(()=>[u("div",Se,[u("div",Ee,[r(B,{modelValue:a.selectedCorte,"onUpdate:modelValue":[t[0]||(t[0]=e=>a.selectedCorte=e),a.loadFacturaciones],options:a.cortes,"option-label":"nombre","option-value":"id",label:"Corte",outlined:"",dense:""},{prepend:l(()=>[r(k,{name:"event"})]),_:1},8,["modelValue","options","onUpdate:modelValue"])]),u("div",Ae,[r(B,{modelValue:a.selectedSede,"onUpdate:modelValue":[t[1]||(t[1]=e=>a.selectedSede=e),a.onSedeChange],options:a.sedeOptions,label:"Sede",outlined:"",dense:"",clearable:""},{prepend:l(()=>[r(k,{name:"location_city"})]),_:1},8,["modelValue","options","onUpdate:modelValue"])]),u("div",Fe,[r(B,{modelValue:a.selectedCarrera,"onUpdate:modelValue":t[2]||(t[2]=e=>a.selectedCarrera=e),options:a.carreraOptions,label:"Carrera",outlined:"",dense:"",clearable:""},{prepend:l(()=>[r(k,{name:"school"})]),_:1},8,["modelValue","options"])]),u("div",Ve,[r(B,{modelValue:a.estadoSubida,"onUpdate:modelValue":[t[3]||(t[3]=e=>a.estadoSubida=e),a.loadFacturaciones],options:a.estadoOptions,label:"Estado",outlined:"",dense:""},{prepend:l(()=>[r(k,{name:"filter_list"})]),_:1},8,["modelValue","options","onUpdate:modelValue"])]),u("div",De,[r(ge,{modelValue:a.searchQuery,"onUpdate:modelValue":t[4]||(t[4]=e=>a.searchQuery=e),outlined:"",dense:"",placeholder:"Buscar por nombre de docente o CI...",clearable:""},{prepend:l(()=>[r(k,{name:"search"})]),_:1},8,["modelValue"])])])]),_:1})]),_:1}),u("div",Be,[u("div",Ue,p(a.filteredFacturaciones.length)+" factura(s) encontrada(s) ",1),u("div",Qe,[a.selected.length>0?(g(),C(F,{key:0,color:"warning",icon:"edit",label:`Editar (${a.selected.length})`,unelevated:"",onClick:a.openBulkEditDialog},{default:l(()=>[r(q,null,{default:l(()=>[...t[10]||(t[10]=[b("Editar Sede/Carrera de seleccionados",-1)])]),_:1})]),_:1},8,["label","onClick"])):D("",!0),r(F,{color:"positive",icon:"download",label:"Exportar a Excel",unelevated:"",onClick:a.exportToExcel,disable:a.filteredFacturaciones.length===0},{default:l(()=>[r(q,null,{default:l(()=>[...t[11]||(t[11]=[b("Descargar datos filtrados en Excel",-1)])]),_:1})]),_:1},8,["onClick","disable"])])]),r(ye,{rows:a.filteredFacturaciones,columns:a.columns,"row-key":"id",loading:a.loading,flat:"",bordered:"","rows-per-page-options":[10,25,50,100],class:"shadow-2",selection:"multiple",selected:a.selected,"onUpdate:selected":t[5]||(t[5]=e=>a.selected=e)},{"body-cell-docente":l(e=>[r(U,{props:e},{default:l(()=>{var f,_,y;return[u("div",null,[u("div",Ie,p((f=e.row.docente)==null?void 0:f.apellidos),1),u("div",null,p((_=e.row.docente)==null?void 0:_.nombre),1),u("div",Oe,"CI: "+p((y=e.row.docente)==null?void 0:y.ci),1)])]}),_:2},1032,["props"])]),"body-cell-sede_carrera":l(e=>[r(U,{props:e},{default:l(()=>{var f,_,y,V;return[u("div",null,p((_=(f=e.row.sede_carrera)==null?void 0:f.sede)==null?void 0:_.nombre),1),u("div",ze,p((V=(y=e.row.sede_carrera)==null?void 0:y.carrera)==null?void 0:V.nombre),1)]}),_:2},1032,["props"])]),"body-cell-tipo_contrato":l(e=>[r(U,{props:e},{default:l(()=>[r(R,{color:e.row.tipo_contrato==="FACTURACION"?"primary":"grey"},{default:l(()=>[b(p(e.row.tipo_contrato),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-fecha_subida":l(e=>[r(U,{props:e},{default:l(()=>[e.row.fecha_subida?(g(),G("div",Te,p(a.formatDate(e.row.fecha_subida)),1)):(g(),G("div",qe,"-"))]),_:2},1032,["props"])]),"body-cell-estado_subida":l(e=>[r(U,{props:e},{default:l(()=>[e.row.estado_subida===null?(g(),C(R,{key:0,color:"grey-6"},{default:l(()=>[r(k,{name:"schedule",size:"xs",class:"q-mr-xs"}),t[12]||(t[12]=b(" Pendiente ",-1))]),_:1})):e.row.estado_subida==="SUBIDA"?(g(),C(R,{key:1,color:"blue"},{default:l(()=>[r(k,{name:"cloud_upload",size:"xs",class:"q-mr-xs"}),t[13]||(t[13]=b(" Subida ",-1))]),_:1})):e.row.estado_subida==="APROBADO"?(g(),C(R,{key:2,color:"positive"},{default:l(()=>[r(k,{name:"check_circle",size:"xs",class:"q-mr-xs"}),t[14]||(t[14]=b(" Aprobado ",-1))]),_:1})):e.row.estado_subida==="DENEGADO"?(g(),C(R,{key:3,color:"negative"},{default:l(()=>[r(k,{name:"cancel",size:"xs",class:"q-mr-xs"}),t[15]||(t[15]=b(" Denegado ",-1))]),_:1})):D("",!0)]),_:2},1032,["props"])]),"body-cell-actions":l(e=>[r(U,{props:e},{default:l(()=>[u("div",Re,[e.row.factura_path?(g(),C(F,{key:0,flat:"",dense:"",round:"",color:"primary",icon:"download",onClick:f=>a.downloadFactura(e.row)},{default:l(()=>[r(q,null,{default:l(()=>[...t[16]||(t[16]=[b("Descargar Factura",-1)])]),_:1})]),_:1},8,["onClick"])):D("",!0),e.row.estado_subida==="SUBIDA"?(g(),C(F,{key:1,flat:"",dense:"",round:"",color:"positive",icon:"check_circle",onClick:f=>a.approveFactura(e.row)},{default:l(()=>[r(q,null,{default:l(()=>[...t[17]||(t[17]=[b("Aprobar Factura",-1)])]),_:1})]),_:1},8,["onClick"])):D("",!0),e.row.estado_subida==="SUBIDA"?(g(),C(F,{key:2,flat:"",dense:"",round:"",color:"negative",icon:"cancel",onClick:f=>a.denyFactura(e.row)},{default:l(()=>[r(q,null,{default:l(()=>[...t[18]||(t[18]=[b("Denegar Factura",-1)])]),_:1})]),_:1},8,["onClick"])):D("",!0)])]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","selected"]),r(_e,{modelValue:a.editDialog,"onUpdate:modelValue":t[8]||(t[8]=e=>a.editDialog=e),persistent:""},{default:l(()=>[r(Y,{style:{"min-width":"350px"}},{default:l(()=>[r(P,null,{default:l(()=>[u("div",Ne,p(a.isBulkEdit?"Editar M\xFAltiples Asignaciones":"Editar Asignaci\xF3n"),1),a.isBulkEdit?(g(),G("div",Pe," Se actualizar\xE1n "+p(a.selected.length)+" registros seleccionados. ",1)):D("",!0)]),_:1}),r(P,{class:"q-pt-none"},{default:l(()=>[u("div",Le,[r(B,{modelValue:a.editForm.sede,"onUpdate:modelValue":[t[6]||(t[6]=e=>a.editForm.sede=e),a.onEditSedeChange],options:a.allSedes,"option-label":"nombre","option-value":"id",label:"Sede",outlined:"",dense:""},null,8,["modelValue","options","onUpdate:modelValue"]),r(B,{modelValue:a.editForm.carrera,"onUpdate:modelValue":t[7]||(t[7]=e=>a.editForm.carrera=e),options:a.availableCarreras,"option-label":"nombre","option-value":"id",label:"Carrera",outlined:"",dense:"",disable:!a.editForm.sede},null,8,["modelValue","options","disable"])])]),_:1}),r(pe,{align:"right",class:"text-primary"},{default:l(()=>[be(r(F,{flat:"",label:"Cancelar"},null,512),[[Ce]]),r(F,{flat:"",label:"Guardar",onClick:a.saveEdit,loading:a.savingEdit},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}var la=he(xe,[["render",Me]]);export{la as default};
