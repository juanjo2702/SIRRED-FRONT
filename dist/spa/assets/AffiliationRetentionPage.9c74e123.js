import{z as m,f as U,n as le,o as q,c as P,w as n,H as c,a as l,Q as B,J as re,I as A,K as ne,N as M,Z as _,L as F,M as O,a0 as se,bf as ie,az as de,b5 as ce}from"./index.0418bc8d.js";import{Q as E}from"./QSelect.e99ebc92.js";import{Q as j}from"./QTooltip.616e6e1b.js";import{Q as z,a as ue}from"./QTable.17f2e81d.js";import{Q as me}from"./QBadge.81599d26.js";import{Q as ve}from"./QPage.c34053e1.js";import{C as pe}from"./ClosePopup.ad21a613.js";import{u as fe}from"./use-quasar.d200e14e.js";import{api as y}from"./axios.0ee954dc.js";import{_ as ge}from"./plugin-vue_export-helper.21dcd24c.js";import"./QChip.9d792c62.js";import"./QItem.b86f3ea8.js";import"./position-engine.40d3e3b8.js";import"./QList.329cacdc.js";const be={name:"AffiliationRetentionPage",setup(){const g=fe(),t=m([]),V=m([]),e=m(null),h=m({label:"Todos",value:null}),b=m(null),a=m(null),v=m(!1),p=m(""),f=m([]),x=m(!1),N=m(!1),w=m({id:null,sede:null,carrera:null}),L=m([]),D=m([]),Q=m([]),G=[{label:"Todos",value:null},{label:"Afiliaci\xF3n",value:"AFILIACION"},{label:"Retenci\xF3n",value:"RETENCION"}],H=[{name:"docente",label:"Docente",align:"left",sortable:!0},{name:"sede_carrera",label:"Sede - Carrera",align:"left"},{name:"tipo_contrato",label:"Tipo",field:"tipo_contrato",align:"center"},{name:"monto",label:"Monto",field:"monto",align:"right",format:o=>`Bs. ${o}`,sortable:!0},{name:"carga_horaria",label:"Carga",field:"carga_horaria",align:"center",sortable:!0}],J=U(()=>{const o=[...new Set(t.value.map(s=>{var i,d;return(d=(i=s.sede_carrera)==null?void 0:i.sede)==null?void 0:d.nombre}).filter(Boolean))];return[{label:"Todas",value:null},...o.map(s=>({label:s,value:s}))]}),K=U(()=>{var i;let o=t.value;(i=b.value)!=null&&i.value&&(o=o.filter(d=>{var r,u;return((u=(r=d.sede_carrera)==null?void 0:r.sede)==null?void 0:u.nombre)===b.value.value}));const s=[...new Set(o.map(d=>{var r,u;return(u=(r=d.sede_carrera)==null?void 0:r.carrera)==null?void 0:u.nombre}).filter(Boolean))];return[{label:"Todas",value:null},...s.map(d=>({label:d,value:d}))]}),Z=U(()=>{var s,i;let o=t.value;if((s=b.value)!=null&&s.value&&(o=o.filter(d=>{var r,u;return((u=(r=d.sede_carrera)==null?void 0:r.sede)==null?void 0:u.nombre)===b.value.value})),(i=a.value)!=null&&i.value&&(o=o.filter(d=>{var r,u;return((u=(r=d.sede_carrera)==null?void 0:r.carrera)==null?void 0:u.nombre)===a.value.value})),p.value){const d=p.value.toLowerCase();o=o.filter(r=>{var C,S,I,k;const u=`${((C=r.docente)==null?void 0:C.apellidos)||""} ${((S=r.docente)==null?void 0:S.nombre)||""}`.toLowerCase(),T=((k=(I=r.docente)==null?void 0:I.ci)==null?void 0:k.toLowerCase())||"";return u.includes(d)||T.includes(d)})}return o}),W=()=>{a.value=null},X=o=>{switch(o){case"AFILIACION":return"purple";case"RETENCION":return"orange";default:return"grey"}},Y=async()=>{try{const o=localStorage.getItem("token"),s=await y.get("/cortes",{headers:{Authorization:`Bearer ${o}`}});V.value=s.data,e.value=V.value.find(i=>i.estado===1)||V.value[0],e.value&&R()}catch{g.notify({type:"negative",message:"Error al cargar cortes"})}},R=async()=>{var o;if(!!e.value){v.value=!0;try{const s=localStorage.getItem("token"),i={corte_id:e.value.id};if((o=h.value)!=null&&o.value)i.tipo_contrato=h.value.value;else{const[r,u]=await Promise.all([y.get("/facturaciones",{params:{...i,tipo_contrato:"AFILIACION"},headers:{Authorization:`Bearer ${s}`}}),y.get("/facturaciones",{params:{...i,tipo_contrato:"RETENCION"},headers:{Authorization:`Bearer ${s}`}})]);t.value=[...r.data,...u.data],v.value=!1;return}const d=await y.get("/facturaciones",{params:i,headers:{Authorization:`Bearer ${s}`}});t.value=d.data}catch{g.notify({type:"negative",message:"Error al cargar datos"})}finally{v.value=!1}}},$=async()=>{var o,s,i;try{const d=localStorage.getItem("token"),r={corte_id:e.value.id};(o=h.value)!=null&&o.value?r.tipo_contrato=h.value.value:r.tipo_contrato="AFILIACION,RETENCION",(s=b.value)!=null&&s.value&&(r.sede_nombre=b.value.value),(i=a.value)!=null&&i.value&&(r.carrera_nombre=a.value.value);const u=await y.get("/facturaciones/export",{params:r,headers:{Authorization:`Bearer ${d}`},responseType:"blob"}),T=window.URL.createObjectURL(new Blob([u.data])),C=document.createElement("a");C.href=T;const S=u.headers["content-disposition"];let I="Afiliacion_Retencion_Export.xlsx";if(S){const k=S.match(/filename="?(.+)"?/);k&&(I=k[1])}C.setAttribute("download",I),document.body.appendChild(C),C.click(),C.remove(),window.URL.revokeObjectURL(T),g.notify({type:"positive",message:"Excel exportado correctamente"})}catch{g.notify({type:"negative",message:"Error al exportar Excel"})}},ee=async()=>{try{const o=localStorage.getItem("token"),[s,i]=await Promise.all([y.get("/sedes",{headers:{Authorization:`Bearer ${o}`}}),y.get("/carreras",{headers:{Authorization:`Bearer ${o}`}})]);L.value=s.data,D.value=i.data}catch(o){console.error("Error loading metadata",o)}},ae=()=>{w.value={id:null,sede:null,carrera:null},Q.value=[],x.value=!0},oe=o=>{if(!o){Q.value=[],w.value.carrera=null;return}Q.value=D.value},te=async()=>{var o,s;if(!w.value.sede||!w.value.carrera){g.notify({type:"warning",message:"Seleccione Sede y Carrera"});return}N.value=!0;try{const i=localStorage.getItem("token"),d=f.value.map(r=>r.id);await y.post("/facturaciones/bulk-update",{ids:d,sede_id:w.value.sede.id,carrera_id:w.value.carrera.id},{headers:{Authorization:`Bearer ${i}`}}),g.notify({type:"positive",message:"Registros actualizados correctamente"}),f.value=[],x.value=!1,R()}catch(i){g.notify({type:"negative",message:((s=(o=i.response)==null?void 0:o.data)==null?void 0:s.message)||"Error al actualizar"})}finally{N.value=!1}};return le(()=>{Y(),ee()}),{facturaciones:t,cortes:V,selectedCorte:e,selectedTipoContrato:h,selectedSede:b,selectedCarrera:a,loading:v,searchQuery:p,tipoContratoOptions:G,sedeOptions:J,carreraOptions:K,filteredFacturaciones:Z,columns:H,onSedeChange:W,getTipoContratoColor:X,loadFacturaciones:R,exportToExcel:$,selected:f,editDialog:x,editForm:w,allSedes:L,availableCarreras:Q,openBulkEditDialog:ae,onEditSedeChange:oe,saveEdit:te,savingEdit:N}}},Ce={class:"row q-col-gutter-md"},_e={class:"col-12 col-sm-6 col-md-2"},ye={class:"col-12 col-sm-6 col-md-2"},we={class:"col-12 col-sm-6 col-md-2"},he={class:"col-12 col-sm-6 col-md-2"},xe={class:"col-12 col-sm-12 col-md-4"},Ee={class:"row justify-between items-center q-mb-md"},Ve={class:"text-subtitle1 text-grey-8"},Se={class:"row q-gutter-sm"},Ie={class:"text-weight-bold"},ke={class:"text-caption text-grey-7"},Ae={class:"text-caption text-grey-7"},Qe={class:"text-caption text-grey-7"},Te={class:"q-gutter-md"};function Be(g,t,V,e,h,b){return q(),P(ve,{padding:""},{default:n(()=>[t[13]||(t[13]=c("div",{class:"q-mb-md"},[c("div",{class:"text-h5 text-weight-medium"},"Control de Afiliaci\xF3n y Retenci\xF3n"),c("div",{class:"text-caption text-grey-7"},"Visualice y exporte las afiliaciones y retenciones de los docentes ")],-1)),l(M,{class:"q-mb-md shadow-2",flat:"",bordered:""},{default:n(()=>[l(B,{class:"bg-grey-2"},{default:n(()=>[...t[9]||(t[9]=[c("div",{class:"text-subtitle1 text-grey-8"},"Filtros",-1)])]),_:1}),l(re),l(B,null,{default:n(()=>[c("div",Ce,[c("div",_e,[l(E,{modelValue:e.selectedCorte,"onUpdate:modelValue":[t[0]||(t[0]=a=>e.selectedCorte=a),e.loadFacturaciones],options:e.cortes,"option-label":"nombre","option-value":"id",label:"Corte",outlined:"",dense:""},{prepend:n(()=>[l(A,{name:"event"})]),_:1},8,["modelValue","options","onUpdate:modelValue"])]),c("div",ye,[l(E,{modelValue:e.selectedTipoContrato,"onUpdate:modelValue":[t[1]||(t[1]=a=>e.selectedTipoContrato=a),e.loadFacturaciones],options:e.tipoContratoOptions,label:"Tipo de Contrato",outlined:"",dense:""},{prepend:n(()=>[l(A,{name:"description"})]),_:1},8,["modelValue","options","onUpdate:modelValue"])]),c("div",we,[l(E,{modelValue:e.selectedSede,"onUpdate:modelValue":[t[2]||(t[2]=a=>e.selectedSede=a),e.onSedeChange],options:e.sedeOptions,label:"Sede",outlined:"",dense:"",clearable:""},{prepend:n(()=>[l(A,{name:"location_city"})]),_:1},8,["modelValue","options","onUpdate:modelValue"])]),c("div",he,[l(E,{modelValue:e.selectedCarrera,"onUpdate:modelValue":t[3]||(t[3]=a=>e.selectedCarrera=a),options:e.carreraOptions,label:"Carrera",outlined:"",dense:"",clearable:""},{prepend:n(()=>[l(A,{name:"school"})]),_:1},8,["modelValue","options"])]),c("div",xe,[l(ne,{modelValue:e.searchQuery,"onUpdate:modelValue":t[4]||(t[4]=a=>e.searchQuery=a),outlined:"",dense:"",placeholder:"Buscar por nombre o CI...",clearable:""},{prepend:n(()=>[l(A,{name:"search"})]),_:1},8,["modelValue"])])])]),_:1})]),_:1}),c("div",Ee,[c("div",Ve,_(e.filteredFacturaciones.length)+" registro(s) encontrado(s) ",1),c("div",Se,[e.selected.length>0?(q(),P(F,{key:0,color:"warning",icon:"edit",label:`Editar (${e.selected.length})`,unelevated:"",onClick:e.openBulkEditDialog},{default:n(()=>[l(j,null,{default:n(()=>[...t[10]||(t[10]=[O("Editar Sede/Carrera de seleccionados",-1)])]),_:1})]),_:1},8,["label","onClick"])):se("",!0),l(F,{color:"positive",icon:"download",label:"Exportar a Excel",unelevated:"",onClick:e.exportToExcel,disable:e.filteredFacturaciones.length===0},{default:n(()=>[l(j,null,{default:n(()=>[...t[11]||(t[11]=[O("Descargar datos filtrados en Excel",-1)])]),_:1})]),_:1},8,["onClick","disable"])])]),l(ue,{rows:e.filteredFacturaciones,columns:e.columns,"row-key":"id",loading:e.loading,flat:"",bordered:"","rows-per-page-options":[10,25,50,100],class:"shadow-2",selection:"multiple",selected:e.selected,"onUpdate:selected":t[5]||(t[5]=a=>e.selected=a)},{"body-cell-docente":n(a=>[l(z,{props:a},{default:n(()=>{var v,p,f;return[c("div",null,[c("div",Ie,_((v=a.row.docente)==null?void 0:v.apellidos),1),c("div",null,_((p=a.row.docente)==null?void 0:p.nombre),1),c("div",ke,"CI: "+_((f=a.row.docente)==null?void 0:f.ci),1)])]}),_:2},1032,["props"])]),"body-cell-sede_carrera":n(a=>[l(z,{props:a},{default:n(()=>{var v,p,f,x;return[c("div",null,_((p=(v=a.row.sede_carrera)==null?void 0:v.sede)==null?void 0:p.nombre),1),c("div",Ae,_((x=(f=a.row.sede_carrera)==null?void 0:f.carrera)==null?void 0:x.nombre),1)]}),_:2},1032,["props"])]),"body-cell-tipo_contrato":n(a=>[l(z,{props:a},{default:n(()=>[l(me,{color:e.getTipoContratoColor(a.row.tipo_contrato)},{default:n(()=>[O(_(a.row.tipo_contrato),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading","selected"]),l(ce,{modelValue:e.editDialog,"onUpdate:modelValue":t[8]||(t[8]=a=>e.editDialog=a),persistent:""},{default:n(()=>[l(M,{style:{"min-width":"350px"}},{default:n(()=>[l(B,null,{default:n(()=>[t[12]||(t[12]=c("div",{class:"text-h6"},"Editar M\xFAltiples Asignaciones",-1)),c("div",Qe," Se actualizar\xE1n "+_(e.selected.length)+" registros seleccionados. ",1)]),_:1}),l(B,{class:"q-pt-none"},{default:n(()=>[c("div",Te,[l(E,{modelValue:e.editForm.sede,"onUpdate:modelValue":[t[6]||(t[6]=a=>e.editForm.sede=a),e.onEditSedeChange],options:e.allSedes,"option-label":"nombre","option-value":"id",label:"Sede",outlined:"",dense:""},null,8,["modelValue","options","onUpdate:modelValue"]),l(E,{modelValue:e.editForm.carrera,"onUpdate:modelValue":t[7]||(t[7]=a=>e.editForm.carrera=a),options:e.availableCarreras,"option-label":"nombre","option-value":"id",label:"Carrera",outlined:"",dense:"",disable:!e.editForm.sede},null,8,["modelValue","options","disable"])])]),_:1}),l(ie,{align:"right",class:"text-primary"},{default:n(()=>[de(l(F,{flat:"",label:"Cancelar"},null,512),[[pe]]),l(F,{flat:"",label:"Guardar",onClick:e.saveEdit,loading:e.savingEdit},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}var Je=ge(be,[["render",Be]]);export{Je as default};
